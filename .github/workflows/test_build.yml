---
name: test-build
on:
  # Triggers the workflow on push or pull request events but
  # only for the main branch
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
permissions: read-all
jobs:
  vanilla-build:
    runs-on: intellabs-01
    container:
      image: osrf/ros:humble-desktop
    permissions:
      # checks: write
      pull-requests: write
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v4.1.1
        with:
          submodules: true
      - name: Setup Dependencies
        run: |
          apt update
          apt install -y python3-pip
          xargs -a deb_requirements.txt apt install -y --no-install-recommends
          rosdep update --rosdistro=humble 
          rosdep install --rosdistro=humble --from-paths . --ignore-src -r -y
          pip3 install -r requirements.txt
      - name: Build
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          colcon build --continue-on-error
          source install/setup.bash
      - name: Test
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          export -n CYCLONEDDS_URI
          export ROS_DOMAIN_ID=2
          colcon test --packages-select \
          scenario_execution \
          scenario_execution_ros \
          scenario_execution_gazebo \
          scenario_coverage \
          --event-handlers console_direct+ \
          --return-code-on-test-failure \
          --pytest-args \
          --junit-xml=TEST.xml
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@f355d34d53ad4e7f506f699478db2dd71da9de5f #v2.15.1
        if: always()
        with:
          check_run: false
          files: |
            scenario_execution//TEST.xml
            scenario_execution_ros//TEST.xml
            scenario_execution_gazebo//TEST.xml
            scenario_coverage//TEST.xml
      - name: Test Example Scenario
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          #shellcheck disable=SC1083
          scenario_batch_execution -i examples/example_scenario/ -o test_example_scenario -- ros2 launch scenario_execution scenario_launch.py scenario:={SCENARIO} output_dir:={OUTPUT_DIR}
      - name: Test Example Library
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          # shellcheck disable=SC1083
          scenario_batch_execution -i examples/example_library/scenarios -o test_example_library -- ros2 launch scenario_execution scenario_launch.py scenario:={SCENARIO} output_dir:={OUTPUT_DIR}
      - name: Test Example Variation
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          scenario_variation -o scenario_variation_out examples/example_scenario_variation/example_scenario_variation.osc
          # shellcheck disable=SC1083
          scenario_batch_execution -i scenario_variation_out -o test_example_variation -- ros2 launch scenario_execution scenario_launch.py scenario:={SCENARIO} output_dir:={OUTPUT_DIR}
      - name: Test Example Scenario Control
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          mkdir test_example_control
          python3 scenario_execution_control/test/scenario_execution_control_test.py scenario_execution_control/test/scenario_execution_control_test.osc &
          timeout 60 ros2 launch scenario_execution_control scenario_execution_control_launch.py scenario_dir:=scenario_execution_control/test/ output_dir:=test_example_control || true
      - name: Publish Scenario Results
        uses: EnricoMi/publish-unit-test-result-action@f355d34d53ad4e7f506f699478db2dd71da9de5f #v2.15.1
        if: always()
        with:
          check_name: Scenario Results
          check_run: false
          action_fail: true
          comment_mode: always
          files: |
            test_example_scenario/test.xml
            test_example_library/test.xml
            test_example_variation/test.xml
            test_example_control/test.xml
      - name: Upload Scenario Results
        uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb
        if: always()
        with:
          name: junit-reports
          path: |
            test_example_scenario/test.xml
            test_example_library/test.xml
            test_example_variation/test.xml
            test_example_control/test.xml
